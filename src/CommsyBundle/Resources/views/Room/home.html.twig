{% extends 'CommsyBundle:Base:room.html.twig' %}

{% form_theme form 'CommsyBundle:Form:uikit_horizontal_dynamic_layout.html.twig' %}

{% block cover %}
    <div id="cover" class="uk-cover-background uk-position-relative cs-cover-background" aria-hidden="false">
        {% if bgImageFilepath is not empty %}
            <img src="{{ bgImageFilepath }}">
        {% endif %}

        <div class="uk-position-cover uk-grid cs-cover-grid">
            {# home information text #}
            <div class="uk-width-medium-2-3 cs-cover-height uk-margin-bottom">
                {% if roomItem.withInformationBox %}
                    <div class="uk-panel uk-panel-box cs-cover-grid-opacity " data-uk-parallax="{opacity: '0.5'}">
                        {{ homeInformationText | raw }}
                    </div>
                {% endif %}
            </div>

            {# announcements #}
            <div class="uk-width-medium-1-3 cs-cover-height">
                {% if countAnnouncements > 0 %}
                    <div class="uk-panel uk-panel-box cs-cover-grid-opacity" data-uk-parallax="{opacity: '0.5'}">
                        <ul id="announcements-feed" class="uk-comment-list" data-uk-observe>
                            {{ render(controller(
                                'CommsyBundle:Announcement:shortfeed',
                                { 'roomId': roomItem.itemId }
                            ))}}
                        </ul>
                    </div>    
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}


{% block content %}
    <div class="uk-grid">

        <div class="uk-width-medium-2-3">
            <div class="uk-panel uk-panel-box uk-panel-box-primary">
                <div class="uk-panel-teaser cs-panel-teaser-primary">
                    <div class="uk-flex uk-flex-middle uk-flex-space-between">
                        <div class="uk-text-large">{{ 'latest entries'|trans({}, "room") }}</div>
                     </div>
                </div>

                <div>
                    <ul id="room-feed" class="uk-comment-list">
                        {{ render(controller(
                            'CommsyBundle:Room:feed',
                            { 'roomId': roomItem.itemId }
                        ))}}
                    </ul>
                    <div class="feed-load-more" data-uk-scrollspy="{cls: 'uk-animation-fade', repeat: true, topoffset: 500}" data-feed='{"url": "{{ app.request.baseURL }}/room/{{ roomItem.itemId }}/feed/", "target": "#room-feed"}'>
                        <i class="uk-icon-refresh uk-icon-spin uk-icon-medium"></i>
                    </div>
                </div>
                
            </div>
        </div>
        
        {# sidebar #}
        <div class="uk-width-medium-1-3 cs-right-column">

            {# room information #}
            <div class="uk-panel uk-panel-box uk-panel-box-primary">
                <div class="uk-panel-teaser cs-panel-teaser-primary">
                    <div class="uk-clearfix">
                        <div class="uk-float-right">
                            <a href="#" class="button-toggle uk-button-mini uk-button-primary" data-uk-toggle="{target: '#room-info', animation: 'uk-animation-fade'}">
                                <i class="uk-icon-chevron-up"></i>
                            </a>
                        </div>
                        <div class="uk-text-large uk-float-left">
                            {{ 'Room-Information'|trans({}, "room") }}
                        </div>
                    </div>
                </div>
               
                <ul id="room-info" class="uk-list uk-list-striped">
                    {% if rss.show %}
                        <li>
                            <a href="{{ rss.url }}">
                                RSS <i class="uk-icon-rss uk-icon-small"></i>
                            </a>
                        </li>
                    {% endif %}
                    <li class="uk-flex">
                        <div class="uk-width-1-3">{{ 'Entries:'|trans({}, "room") }}</div>
                        <div class="uk-width-2-3">
                            {% transchoice numNewEntries with {'%days%': timeSpread, '%num%': numNewEntries} from "room" %}
                                One new entry in the last %days% days|%num% new entries in the last %days% days
                            {% endtranschoice %}
                        </div>
                    </li>
                    <li class="uk-flex">
                        <div class="uk-width-1-3">{{ 'Persons:'|trans({}, "room") }}</div>
                        <div class="uk-width-2-3">
                            {% trans with {'%total%': numTotalMember, '%active%': numActiveMember} from "room" %}
                                total %total% | active %active%
                            {% endtrans %}
                            <div class="uk-progress">
                                {% set activePercent = (numActiveMember/numTotalMember*100)|round %}
                                <div class="uk-progress-bar cs-progress-bar" style="width: {{ activePercent }}%;"></div>
                            </div>
                        </div>
                    </li>
                    <li  class="uk-flex">
                        <div class="uk-width-1-3">{% trans from "room" %}Page Impressions:{% endtrans %}</div>
                        <div class="uk-width-2-3">{{ pageImpressions }}</div>
                    </li>
                    <li  class="uk-flex uk-flex-column">
                        <div class="uk-flex">
                            <div class="uk-width-1-3">{{ 'Moderation:'|trans({}, "room") }}</div>
                            <div class="uk-width-2-3">
                                {% for roomModerator in roomModerators %}
                                    <a href="{{ path('commsy_user_detail', {'roomId': roomItem.itemId, 'itemId': roomModerator.itemId}) }}">{{ roomModerator.fullName }}</a>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                <br/>
                                <a id="cs-moderation-support-link" href="#" data-form-url="{{ path('commsy_room_moderationsupport', {'roomId': roomItem.itemId}) }}">{{ 'moderation support'|trans({}, "room") }}</a>
                            </div>
                        </div>
                        <div class="uk-flex">
                            <div id="cs-moderation-support-spinner" class="uk-margin-small-top uk-margin-small-bottom uk-container-center uk-hidden">
                                <i class="uk-icon-spinner uk-icon-small uk-icon-spin"></i>
                            </div>
                        </div>
                        <div class="uk-flex">
                            <div id="cs-moderation-support" class="uk-width-1-1 uk-hidden">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>

            {# filter #}
            <div class="uk-panel uk-panel-box uk-panel-box-primary">
                <div class="uk-panel-teaser cs-panel-teaser-primary">
                    <div class="uk-clearfix">
                        <div class="uk-float-right">
                            <a href="#" class="button-toggle uk-button-mini uk-button-primary" data-uk-toggle="{target: '#list-filter', animation: 'uk-animation-fade'}">
                                <i class="uk-icon-chevron-up"></i>
                            </a>
                        </div>
                        <div class="uk-text-large uk-float-left">
                            {{ 'list filter'|trans({}, "room") }} 
                        </div>
                    </div>
                </div>
                <div id="list-filter">
                    {{ form_start(form) }}
                    {{ form_widget(form) }}
                    {{ form_end(form) }}
                </div>
 
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        console.debug("Cover dimensions:");
        var cover_width = $("#cover").width();
        var cover_height = $("#cover").height();
        console.debug(" - width: " + cover_width);
        console.debug(" - height: " + cover_height);
        console.debug(" => aspect ratio: " + (cover_width / cover_height) + " - 1");

        console.debug("Cover image dimensions:");
        var img_width = $("#cover img").width();
        var img_height = $("#cover img").height();
        console.debug(" - width: " + img_width);
        console.debug(" - height: " + img_height);
        console.debug(" => aspect ratio: " + (img_width / img_height) + " - 1");

        var height_diff = img_height - cover_height;
        console.debug("---------------------");
        console.debug(" => height diff: " + height_diff);

        if(height_diff < 0){
            console.debug("Image height < cover element height");
            console.debug(" => image clipping needed!");

            var cover_ratio = cover_width / cover_height;       // 4.64
            height_diff = 100;
            var new_img_width = img_height * cover_ratio - height_diff;

            console.debug(" => using image clip with dimensions:");
            console.debug(" - new width " + new_img_width + " (original width: "+ img_width + ")");
            console.debug(" - height: " + img_height);
            console.debug(" => new aspect ratio: " + (new_img_width / img_height));

            var clip_rect = "rect(0px, 0px, "+img_height+"px, "+new_img_width+"px)";

            console.debug(" => using clip: " + clip_rect);

            // FIXME: "clipping" image doesn't seem to have any effect!
            $("#cover img").css("clip", clip_rect).css("width", cover_width);
        }

        else{
            console.debug(" => Adding uikit parallax attribute with vertical scrolling value = "+height_diff+" to cover image...");
            $("#cover img").attr("data-uk-parallax", "{y: '-"+height_diff+"'}");
        }
    </script>
{% endblock %}
