//>>built
define("dojox/grid/enhanced/plugins/Rearrange","dojo/_base/kernel,dojo/_base/lang,dojo/_base/declare,dojo/_base/array,dojo/_base/connect,../../EnhancedGrid,../_Plugin,./_RowMapLayer".split(","),function(p,r,s,k,m,u,v,w){p=s("dojox.grid.enhanced.plugins.Rearrange",v,{name:"rearrange",constructor:function(b,a){this.grid=b;this.setArgs(a);var e=new w(b);dojox.grid.enhanced.plugins.wrap(b,"_storeLayerFetch",e)},setArgs:function(b){this.args=r.mixin(this.args||{},b||{});this.args.setIdentifierForNewItem=
this.args.setIdentifierForNewItem||function(a){return a}},destroy:function(){this.inherited(arguments);this.grid.unwrap("rowmap")},onSetStore:function(){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(b){var a=this.grid,e=a.store,g=a.layout.cells;return e.getFeatures()["dojo.data.api.Identity"]&&k.some(b,function(c){return e.getIdentityAttributes(a._by_idx[c.r].item)==g[c.c].field})?!0:!1},moveColumns:function(b,a){var e=this.grid,g=e.layout,c=g.cells,h,d,f=0,i=!0;h={};var j={};b.sort(function(a,
c){return a-c});for(d=0;d<b.length;++d)h[b[d]]=d,b[d]<a&&++f;var l=0,n=0,k=Math.max(b[b.length-1],a);k==c.length&&--k;var q=Math.min(b[0],a);for(d=q;d<=k;++d){var o=h[d];0<=o?j[d]=a-f+o:d<a?(j[d]=q+l,++l):d>=a&&(j[d]=a+b.length-f+n,++n)}f=0;a==c.length&&(--a,i=!1);e._notRefreshSelection=!0;for(d=0;d<b.length;++d){h=b[d];h<a&&(h-=f);++f;if(h!=a)g.moveColumn(c[h].view.idx,c[a].view.idx,h,a,i),c=g.cells;a<=h&&++a}delete e._notRefreshSelection;m.publish("dojox/grid/rearrange/move/"+e.id,["col",j,b])},
moveRows:function(b,a){var e=this.grid,g={},c=[],h=[],d=b.length,f,i,j;for(f=0;f<d;++f){h=b[f];if(h>=a)break;c.push(h)}h=b.slice(f);if(d=c.length){j={};k.forEach(c,function(a){j[a]=!0});g[c[0]]=a-d;for(i=0,f=c[i]+1,c=f-1;f<a;++f)j[f]?(++i,g[f]=a-d+i):(g[f]=c,++c)}c=h;if(d=c.length){j={};k.forEach(c,function(a){j[a]=!0});g[c[d-1]]=a+d-1;for(i=d-1,f=c[i]-1,c=f+1;f>=a;--f)j[f]?(--i,g[f]=a+i):(g[f]=c,--c)}var l=r.clone(g);e.layer("rowmap").setMapping(g);e.forEachLayer(function(a){return"rowmap"!=a.name()?
(a.invalidate(),!0):!1},!1);e.selection.selected=[];e._noInternalMapping=!0;e._refresh();setTimeout(function(){m.publish("dojox/grid/rearrange/move/"+e.id,["row",l,b]);e._noInternalMapping=!1},0)},moveCells:function(b,a){var e=this.grid,g=e.store;if(g.getFeatures()["dojo.data.api.Write"]&&!(b.min.row==a.min.row&&b.min.col==a.min.col)){var c=e.layout.cells,h,d,f,i,j=[],l=[];for(h=b.min.row,f=a.min.row;h<=b.max.row;++h,++f)for(d=b.min.col,i=a.min.col;d<=b.max.col;++d,++i){for(;c[d]&&c[d].hidden;)++d;
for(;c[i]&&c[i].hidden;)++i;j.push({r:h,c:d});l.push({r:f,c:i,v:c[d].get(h,e._by_idx[h].item)})}this._hasIdentity(j.concat(l))?console.warn("Can not write to identity!"):(k.forEach(j,function(a){g.setValue(e._by_idx[a.r].item,c[a.c].field,"")}),k.forEach(l,function(a){g.setValue(e._by_idx[a.r].item,c[a.c].field,a.v)}),g.save({onComplete:function(){m.publish("dojox/grid/rearrange/move/"+e.id,["cell",{from:b,to:a}])}}))}},copyCells:function(b,a){var e=this.grid,g=e.store;if(g.getFeatures()["dojo.data.api.Write"]&&
!(b.min.row==a.min.row&&b.min.col==a.min.col)){var c=e.layout.cells,h,d,f,i,j=[];for(h=b.min.row,f=a.min.row;h<=b.max.row;++h,++f)for(d=b.min.col,i=a.min.col;d<=b.max.col;++d,++i){for(;c[d]&&c[d].hidden;)++d;for(;c[i]&&c[i].hidden;)++i;j.push({r:f,c:i,v:c[d].get(h,e._by_idx[h].item)})}this._hasIdentity(j)?console.warn("Can not write to identity!"):(k.forEach(j,function(a){g.setValue(e._by_idx[a.r].item,c[a.c].field,a.v)}),g.save({onComplete:function(){setTimeout(function(){m.publish("dojox/grid/rearrange/copy/"+
e.id,["cell",{from:b,to:a}])},0)}}))}},changeCells:function(b,a,e){var g=this.grid,c=g.store;if(c.getFeatures()["dojo.data.api.Write"]){var h=g.layout.cells,d=b.layout.cells,f,i,j,l,n=[];for(f=a.min.row,j=e.min.row;f<=a.max.row;++f,++j)for(i=a.min.col,l=e.min.col;i<=a.max.col;++i,++l){for(;d[i]&&d[i].hidden;)++i;for(;h[l]&&h[l].hidden;)++l;n.push({r:j,c:l,v:d[i].get(f,b._by_idx[f].item)})}this._hasIdentity(n)?console.warn("Can not write to identity!"):(k.forEach(n,function(a){c.setValue(g._by_idx[a.r].item,
h[a.c].field,a.v)}),c.save({onComplete:function(){m.publish("dojox/grid/rearrange/change/"+g.id,["cell",e])}}))}},clearCells:function(b){var a=this.grid,e=a.store;if(e.getFeatures()["dojo.data.api.Write"]){var g=a.layout.cells,c,h,d=[];for(c=b.min.row;c<=b.max.row;++c)for(h=b.min.col;h<=b.max.col;++h){for(;g[h]&&g[h].hidden;)++h;d.push({r:c,c:h})}this._hasIdentity(d)?console.warn("Can not write to identity!"):(k.forEach(d,function(c){e.setValue(a._by_idx[c.r].item,g[c.c].field,"")}),e.save({onComplete:function(){m.publish("dojox/grid/rearrange/change/"+
a.id,["cell",b])}}))}},insertRows:function(b,a,e){try{var g=this.grid,c=g.store,h=g.rowCount,d={},f=0,i=[],j,l=0>e,n=this,p=a.length;if(l)e=0;else for(j=e;j<g.rowCount;++j)d[j]=j+p;if(c.getFeatures()["dojo.data.api.Write"]){if(b){var q=b.store,o,t;if(l)t=k.filter(k.map(g.layout.cells,function(a){return a.field}),function(a){return a});else{for(j=0;!o;++j)o=g._by_idx[j];t=c.getAttributes(o.item)}var s=[];k.forEach(a,function(a,g){var j={},l=b._by_idx[a];if(l){k.forEach(t,function(a){j[a]=q.getValue(l.item,
a)});j=n.args.setIdentifierForNewItem(j,c,h+f)||j;try{c.newItem(j),i.push(e+g),d[h+f]=e+g,++f}catch(m){}}else s.push(a)})}else if(a.length&&r.isObject(a[0]))k.forEach(a,function(a,b){var g=n.args.setIdentifierForNewItem(a,c,h+f)||a;try{c.newItem(g),i.push(e+b),d[h+f]=e+b,++f}catch(j){}});else return;g.layer("rowmap").setMapping(d);c.save({onComplete:function(){g._refresh();setTimeout(function(){m.publish("dojox/grid/rearrange/insert/"+g.id,["row",i])},0)}})}}catch(u){}},removeRows:function(b){var a=
this.grid,e=a.store;try{k.forEach(k.map(b,function(c){return a._by_idx[c]}),function(a){a&&e.deleteItem(a.item)}),e.save({onComplete:function(){m.publish("dojox/grid/rearrange/remove/"+a.id,["row",b])}})}catch(g){}},_getPageInfo:function(){var b=this.grid.scroller,a=b.page,e=b.page,g=b.firstVisibleRow,c=b.lastVisibleRow,h=b.rowsPerPage,d,f,i,j=[];k.forEach(b.pageNodes[0],function(b,k){b&&(i=!1,d=k*h,f=(k+1)*h-1,g>=d&&g<=f&&(a=k,i=!0),c>=d&&c<=f&&(e=k,i=!0),!i&&(d>c||f<g)&&j.push(k))});return{topPage:a,
bottomPage:e,invalidPages:j}}});u.registerPlugin(p);return p});