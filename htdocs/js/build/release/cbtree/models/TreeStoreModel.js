//>>built
define("cbtree/models/TreeStoreModel","dojo/_base/array,dojo/_base/declare,dojo/_base/lang,dojo/aspect,dojo/has,dojo/json,dojo/Stateful,./ItemWriteStoreEX".split(","),function(h,m,f,i,l,o,p){return m([p],{checkedAll:!0,checkedState:!1,checkedRoot:!1,checkedStrict:!0,checkedAttr:"checked",childrenAttrs:["children"],deferItemLoadingUntilExpand:!1,enabledAttr:"",excludeChildrenAttrs:null,iconAttr:"",labelAttr:"",multiState:!0,newItemIdAttr:"id",normalize:!0,query:null,store:null,moduleName:"cbTree/models/TreeStoreModel",
hasFakeRoot:!1,root:null,_checkedChildrenAttrs:null,_queryAttrs:[],_validateStore:!0,_validating:0,constructor:function(a){m.safeMixin(this,a);this.connects=[];a=this.store;if(!a.getFeatures()["dojo.data.api.Identity"])throw Error(this.moduleName+"constructor(): store must support dojo.data.Identity");l.add("tree-model-getChecked",1);a.getFeatures()["dojo.data.api.Write"]?(l.add("tree-model-setChecked",1),this._writeEnabled=!0):(console.warn(this.moduleName+"::constructor(): store is not write enabled."),
this._writeEnabled=!1);if(a.getFeatures()["dojo.data.api.Notification"])this.connects=this.connects.concat([i.after(a,"onLoad",f.hitch(this,"onStoreLoaded"),!0),i.after(a,"onNew",f.hitch(this,"onNewItem"),!0),i.after(a,"onDelete",f.hitch(this,"onDeleteItem"),!0),i.after(a,"onSet",f.hitch(this,"onSetItem"),!0),i.after(a,"onRoot",f.hitch(this,"onRootChange"),!0)]);this._checkedChildrenAttrs=this._diffArrays(this.childrenAttrs,this.excludeChildrenAttrs);if(this.query)for(var b in this.query)this._queryAttrs.push(b)},
destroy:function(){for(var a;a=this.connects.pop();)a.remove();this.store=null},_checkedStrictSetter:function(a){a=a?!0:!1;if(this.checkedStrict!==a)(this.checkedStrict=a)&&this.getRoot(f.hitch(this,function(a){this.getChildren(a,f.hitch(this,function(c){this._validateChildren(a,c)}))}));return this.checkedStrict},_enabledAttrSetter:function(a){if(f.isString(a)){if(this.enabledAttr!==a)throw Error(this.moduleName+"::set(): enabledAttr property is read-only.");}else throw Error(this.moduleName+"::set(): enabledAttr value must be a string");
return this.enabledAttr},_labelAttrGetter:function(){return this.getLabelAttr()},_labelAttrSetter:function(a){return this.setLabelAttr(a)},_querySetter:function(a){if(f.isObject(a)){if(this.query!==a)this.query=a,this._requeryTop();return this.query}throw Error(this.moduleName+"::set(): query argument must be of type object");},getChildren:function(a,b,c,d){var e=this.store,g=this;if(e.isItemLoaded(a)){var j=[],n,k;if(d){var i=f.isArray(d)?d:[d];for(k=0;k<i.length;k++)n=e.getValues(a,i[k]),j=j.concat(n)}else for(k=
0;k<this.childrenAttrs.length;k++)n=e.getValues(a,this.childrenAttrs[k]),j=j.concat(n);var l=0;this.deferItemLoadingUntilExpand||h.forEach(j,function(a){e.isItemLoaded(a)||l++});0==l?b(j):h.forEach(j,function(a,d){e.isItemLoaded(a)||e.loadItem(g._mixinFetch({item:a,onItem:function(a){j[d]=a;0==--l&&b(j)},onError:c}))})}else{var m=f.hitch(this,arguments.callee);e.loadItem(g._mixinFetch({item:a,onItem:function(a){m(a,b,c)},onError:c}))}},getParents:function(a){if(a)return this.store.getParents(a)},
getRoot:function(a,b){this.root?a(this.root):this.store.fetch(this._mixinFetch({query:this.query,onComplete:f.hitch(this,function(b){if(1!=b.length)throw Error(this.moduleName+": query "+o.stringify(this.query)+" returned "+b.length+" items, but must return exactly one item");this.root=b[0];a(this.root)}),onError:b}))},mayHaveChildren:function(a){return h.some(this.childrenAttrs,function(b){return this.store.hasAttribute(a,b)},this)},_getCompositeState:function(a){var b=!1,c=!1,d=!1,e,g;h.some(a,
function(a){g=this.getChecked(a);d|="mixed"==g;switch(g){case !0:b=!0;break;case !1:c=!0}return d},this);if(d||b||c)e=(d|=!(b^c))?"mixed":b?!0:!1;return e},_normalizeState:function(a,b){return"boolean"==typeof b?b:this.multiState&&"mixed"==b?this.normalize&&!this.mayHaveChildren(a)?!0:b:b?!0:!1},_setChecked:function(a,b){var c=!1,d;d=this._normalizeState(a,b);c=d!=b;if(this.store.isItem(a)){var e=this.store.getValue(a,this.checkedAttr);if((void 0!==e||this.checkedAll)&&(e!=d||c))return this.store.setValue(a,
this.checkedAttr,d),!0}else if(a===this.root&&this.hasFakeRoot){if(this.checkedRoot&&(this.root[this.checkedAttr]!=d||c))return this.root[this.checkedAttr]=d,this.onChange(a,this.checkedAttr,d),!0}else throw new TypeError(this.moduleName+"::_setChecked(): invalid item specified.");return!1},_updateCheckedChild:function(a,b){this._setChecked(a,b);this.mayHaveChildren(a)&&this.getChildren(a,f.hitch(this,function(a){h.forEach(a,function(a){this._updateCheckedChild(a,b)},this)}),this.onError,this._checkedChildrenAttrs)},
_updateCheckedParent:function(a,b){if(this.checkedStrict&&a){var c=this.getParents(a),d=this.getChecked(a),e;h.forEach(c,function(c){this.isChildOf(c,a)&&(d!==this.getChecked(c)||b)&&this.getChildren(c,f.hitch(this,function(a){e=this._getCompositeState(a);void 0!==e&&this._setChecked(c,e)}),this.onError,this._checkedChildrenAttrs)},this)}},_validateChildren:function(a,b,c){var d;this._validating+=1;b=f.isArray(b)?b:[b];h.forEach(b,function(a){this.mayHaveChildren(a)?this.getChildren(a,f.hitch(this,
function(b){this._validateChildren(a,b,c)}),this.onError,c):(d=this.getChecked(a))&&"boolean"!==typeof d&&(a[this.checkedAttr]=[this._normalizeState(a,d)])},this);b=this._getCompositeState(b);d=this.getChecked(a);void 0!==d&&void 0!==b&&this._setChecked(a,b);this._validating-=1;this._validating||(this.store.setValidated(!0),this.onDataValidated())},getChecked:function(a){var b;if(!this.excludeChildrenAttrs||!this.isMemberOf(a,this.excludeChildrenAttrs)){if(this.store.isItem(a)){if(b=this.store.getValue(a,
this.checkedAttr),void 0===b&&this.checkedAll)return this._setChecked(a,this.checkedState),this.checkedState}else if(a===this.root&&this.hasFakeRoot){if(this.checkedRoot)return this.root[this.checkedAttr]}else throw new TypeError(this.moduleName+"::getChecked(): invalid item specified.");return b}},getEnabled:function(a){var b=!0;if(this.enabledAttr)if(this.store.isItem(a))b=this.store.getValue(a,this.enabledAttr);else if(a===this.root)b=a[this.enabledAttr];else throw new TypeError(this.moduleName+
"::getEnabled(): invalid item specified.");return void 0===b||Boolean(b)},getItemState:function(a){return{checked:this.getChecked(a),enabled:this.getEnabled(a)}},setChecked:function(a,b){this.checkedStrict?this._updateCheckedChild(a,b):this._setChecked(a,b)},setEnabled:function(a,b){if(this.enabledAttr){if(this.store.isItem(a))return this.store.setValue(a,this.enabledAttr,Boolean(b));if(a===this.root)return this.root[this.enabledAttr]=Boolean(b);throw new TypeError(this.moduleName+"::setEnabled(): invalid item specified.");
}},validateData:function(){this.checkedStrict?this.store.isValidated()?(this.hasFakeRoot&&this.getChildren(this.root,f.hitch(this,function(a){this._updateCheckedParent(a[0],!0)}),this.onError,this._checkedChildrenAttrs),this.onDataValidated()):this.store.loadStore({onComplete:function(){l("tree-model-setChecked")?this._validateStore&&this.getRoot(f.hitch(this,function(a){this.getChildren(a,f.hitch(this,function(b){this._validateChildren(a,b,this._checkedChildrenAttrs)}),this.onError)}),this.onError):
console.warn(this.moduleName+"::validateData(): store is not write enabled.")},onError:function(){},scope:this}):this.store.setValidated(!1)},fetchItemByIdentity:function(a){this.store.fetchItemByIdentity(a)},getIcon:function(a){if(this.iconAttr)return this.store.getValue(a,this.iconAttr)},getIdentity:function(a){return this.store.getIdentity(a)},getLabel:function(a){if(this.labelAttr)return this.store.getValue(a,this.labelAttr);this.setLabelAttr(this.getLabelAttr());return this.store.getLabel(a)},
isItem:function(a){return this.store.isItem(a)},isTreeRootChild:function(a){if(this.root)return this.isChildOf(this.root,a)},isChildOf:function(a,b){var c;for(c=0;c<this.childrenAttrs.length;c++)if(-1!==h.indexOf(a[this.childrenAttrs[c]],b))return!0;return!1},isMemberOf:function(a,b){if(this.isItem(a)){var c=this.getParents(a),d=b?f.isArray(b)?b:[b]:[],e=!1,g;h.some(c,function(b){for(g=0;g<d.length;g++)if(-1!=h.indexOf(b[d[g]],a))return e=!0},this)}return e},deleteItem:function(a){return this.store.deleteItem(a)},
newItem:function(a,b,c,d){var d={parent:b,attribute:d?d:this.childrenAttrs[0]},e;this._mapIdentifierAttr(a,!1);try{(e=this.store.itemExist(a))?this.pasteItem(e,null,b,!0,c):(e=this.store.newItem(a,d))&&void 0!=c&&this.pasteItem(e,b,b,!1,c)}catch(f){throw Error(this.moduleName+"::newItem(): "+f);}return e},pasteItem:function(a,b,c,d,e,f){var j=f?f:this.childrenAttrs[0],i=this.store;b&&h.forEach(this.childrenAttrs,function(c){i.containsValue(b,c,a)&&(d||i.removeReference(a,b,c),j=c)},this);c&&i.addReference(a,
c,j,e)},getLabelAttr:function(){if(!this.labelAttr){var a=this.store.getLabelAttributes();a&&this.setLabelAttr(a[0])}return this.labelAttr},setLabelAttr:function(a){if(f.isString(a)&&a.length){if(this.labelAttr!==a){var b=this.labelAttr;this.labelAttr=a;this.onLabelChange(b,a)}return this.labelAttr}},onChange:function(){},onChildrenChange:function(){},onDataValidated:function(){},onDelete:function(){},onLabelChange:function(){},onNewItem:function(a,b){b&&this.getChildren(b.item,f.hitch(this,function(a){this.onChildrenChange(b.item,
a)}));this._updateCheckedParent(a,!0)},onDeleteItem:function(a){this.onDelete(a)},onError:function(a){console.error(this,a)},onSetItem:function(a,b,c,d){-1!=h.indexOf(this.childrenAttrs,b)?this.getChildren(a,f.hitch(this,function(b){b[0]?this._updateCheckedParent(b[0],!0):this._setChecked(a,this.checkedState);this.onChildrenChange(a,b)})):(b==this.checkedAttr&&this._updateCheckedParent(a,!1),this.onChange(a,b,d))},onStoreLoaded:function(){this.getLabelAttr()},onRootChange:function(){},_mapIdentifierAttr:function(a,
b){var c=this.store.getIdentifierAttr();if(c&&!a[c]&&this.newItemIdAttr&&a[this.newItemIdAttr])return a[c]=a[this.newItemIdAttr],b&&delete a[this.newItemIdAttr],!0;if(this.checkedAll&&void 0===a[this.checkedAttr])a[this.checkedAttr]=this.checkedState;return!1},_diffArrays:function(a,b){var c=b?f.isArray(b)?b:[b]:[],d=a.slice(0),e,g;if(d.length&&c.length)for(g=0;g<c.length;g++)e=h.indexOf(d,c[g]),-1!=e&&d.splice(e,1);return d},_mixinFetch:function(a){return a}})});