{% import 'utils/macros.html.twig' as macros %}

<div class="uk-margin-right uk-margin-bottom uk-position-relative uk-padding-remove">
    {% include 'utils/save_spinner.html.twig' %}
    <div class="uk-form-horizontal">
        {{ form_start(form) }}
        {{ form_errors(form) }}
        <div class="uk-flex">
            <div class="uk-width-9-10">
                {{ form_widget(form.title) }}
                {{ form_errors(form.title) }}
            </div>
        </div>
        {% if form.vars.name != "section"  %}
            <div class="uk-margin-small-left uk-margin-small-top">
                {% if form.editor_switch is defined %}
                    <div class="uk-form-row">
                        {{ form_label(form.editor_switch) }}
                        <div class="uk-margin-left">
                            {{ form_widget(form.editor_switch) }}
                            <i class="uk-icon-question-circle uk-icon-justify uk-icon-small uk-icon-bottom uk-margin-small-top" data-uk-tooltip="{pos:'right'}" title="{{ 'etherpadText' | trans({}, 'form') }}"></i>
                        </div>
                    </div>
                {% endif %}

                {% if material.creator.itemId == currentUser.itemId or currentUser.isModerator %}
                <div class="uk-form-row">
                    <label class="uk-form-label">
                        <span data-uk-tooltip title="{{ macros.userFullname(material.creator) }}">{{ 'permission'|trans({}, "form") }}</span>
                    </label>
                    <div>
                        {{ form_widget(form.permission) }}
                        <i class="uk-icon-question-circle uk-icon-small uk-icon-justify uk-icon-bottom uk-margin-small-top" data-uk-tooltip="{pos:'right'}" title="{{ 'permission-info'|trans({'%name%': macros.userFullname(material.creator)}, 'form') }}"></i>
                    </div>
                </div>
                <div class="uk-form-row">
                    <label class="uk-form-label">{{ 'hidden'|trans({}, "form")|capitalize }}</label>
                    <div>
                        {{ form_widget(form.hidden) }}
                    </div>
                </div>
                <div class="uk-form-row">
                    <label class="uk-form-label">{{ 'hidden until'|trans({}, "form")|capitalize }}</label>
                    <div class="uk-margin-small-top">
                        {{ form_widget(form.hiddendate) }}
                    </div>
                </div>
                {% endif %}

                {% if form.external_viewer is defined %}
                    <div class="uk-form-row">
                        {{ form_row(form.external_viewer) }}
                        <i class="uk-icon-question-circle uk-icon-justify uk-icon-small uk-icon-bottom" data-uk-tooltip="{pos:'right'}" title="{{ 'external_viewer_desc' | trans({}, 'form') }}"></i>
                    </div>
                {%  endif %}

                {% if isDraft and (showHashtags or showCategories) %}
                    {{ macros.mandatoryLinks(showHashtags, showCategories, form) }}
                    {% include 'utils/save_spinner.html.twig' %}

                    <ul class='form-errors'>
                        {% if form.categories is defined %}
                            {% if form.categories.vars.errors|length %}
                                <li>{{ 'categories'|trans({})|capitalize }}: {{ form.categories.vars.errors[0].message }}</li>
                            {% endif %}
                        {% endif %}
                        {% if form.hashtags is defined %}
                            {% if form.hashtags.vars.errors|length %}
                                <li>{{ 'hashtags'|trans({}, 'room')|capitalize }}: {{ form.hashtags.vars.errors[0].message }}</li>
                            {% endif %}
                        {% endif %}
                    </ul>

                    <ul id="linksFormTabs" class="uk-tab" data-uk-tab="{connect:'#linksForm'}">
                        <li><a href="">{{ 'Entries'|trans({}) }}</a></li>

                    </ul>
                    <!-- This is the container of the content items -->
                    <ul id="linksForm" class="uk-switcher uk-margin">
                        <li>
                            <div class="uk-grid">
                                <div class="uk-width-1-1">

                                    <ul class="uk-tab uk-tab-bottom" data-uk-switcher="{connect:'#linked-entry-switcher'}">
                                        <li><a href="">{{ 'Search'|trans({}, 'search') }}</a></li>
                                        <li><a href="">{{ 'lastModifiedEntries'|trans({}) }}</a></li>
                                    </ul>

                                    <ul id="linked-entry-switcher" class="uk-switcher uk-margin-bottom uk-margin-top">
                                        <li>
                                            {# search entries #}
                                            {{ render(controller(
                                                'App\\Controller\\SearchController::itemSearchFormAction',
                                                { 'roomId': app.request.attributes.get('roomId'), 'linkSearch': itemId }
                                            )) }}
                                        </li>
                                        <li>
                                            <div id="linksSubTab">
                                                {# latest entries #}
                                                {{ 'lastModifiedEntries'|trans({}) }}
                                                <div>
                                                    <ul class="uk-comment-list">
                                                        {% for key, entry in form.itemsLatest.vars.choices %}

                                                            {% if items[entry.value] is defined %}

                                                                {% set currentItem = items[entry.value] %}
                                                                <article class="uk-comment selectable" data-cs-linked-items>
                                                                    <header class="uk-comment-header uk-flex">
                                                                        <div class="items-checkbox uk-margin-right uk-margin-top">
                                                                            {{ form_widget(form.itemsLatest[key]) }}
                                                                        </div>
                                                                        <div class="uk-margin-right uk-flex-item-none">
                                                                            {% if not currentItem.modificatorItem.isDeleted and currentItem.modificatorItem.isUser %}
                                                                                {{ macros.userIconLink(currentItem.modificatorItem) }}
                                                                            {% else %}
                                                                                {{ macros.userIcon(currentItem.modificatorItem) }}
                                                                            {% endif %}
                                                                            <div class="uk-comment-meta">
                                                                        <span class="uk-text-nowrap">
                                                                            {% if currentItem.modificationDate|date("d.m.Y") == "now"|date("d.m.Y") %}
                                                                                {{ 'today'|trans({})|capitalize }}, {{ currentItem.modificationDate|date("H:i") }}
                                                                            {% else %}
                                                                                {{ currentItem.modificationDate|craue_date }}
                                                                            {% endif %}
                                                                        </span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="uk-width-8-10">
                                                                            <h4 class="uk-comment-title">
                                                                                <a href="">{{ form_label(form.itemsLatest[key]) }}</a>
                                                                            </h4>
                                                                            <div class="uk-comment-meta">
                                                                                {{ 'by'|trans({})|capitalize }}: {{ macros.userFullname(currentItem.modificatorItem) }} ({{ currentItem.creationDate|craue_date }})
                                                                            </div>
                                                                        </div>
                                                                        <div class="uk-width-2-10 uk-text-right">
                                                                            {% if currentItem.type is same as('todo') %}
                                                                                <i class="{{ macros.iconClassForItemType(currentItem.itemType, currentItem.internalStatus) }} uk-icon-small" data-uk-tooltip title="{{ currentItem.status }}"></i>
                                                                            {% else %}
                                                                                <i class="{{ macros.iconClassForItemType(currentItem.itemType) }} uk-icon-small"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    </header>
                                                                </article>
                                                            {% endif %}
                                                        {% endfor %}

                                                        {% do form.itemsLatest.setRendered %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                    {# linked entries #}
                                    <div>{{ 'linkedEntries'|trans({}) }}</div>
                                    <div id="itemsLinkedListWrapper" class="uk-block uk-block-muted uk-padding-remove uk-margin cs-form-scroll">
                                        <ul id="itemsLinkedList" class="uk-comment-list">

                                            {% for entry in form.itemsLinked %}
                                                {% if items[entry.vars.name] is defined %}

                                                    {% set currentItem = items[entry.vars.name] %}
                                                    <article class="uk-comment selectable uk-comment-primary" data-cs-linked-items>
                                                        <header class="uk-comment-header uk-flex">
                                                            <div class="items-checkbox uk-margin-right uk-margin-top">
                                                                {{ form_widget(entry) }}
                                                            </div>
                                                            <div class="uk-margin-right uk-flex-item-none">
                                                                {% if not currentItem.modificatorItem.isDeleted and currentItem.modificatorItem.isUser %}
                                                                    {{ macros.userIconLink(currentItem.modificatorItem) }}
                                                                {% else %}
                                                                    {{ macros.userIcon(currentItem.modificatorItem) }}
                                                                {% endif %}
                                                                <div class="uk-comment-meta">
                                                            <span class="uk-text-nowrap">
                                                                {% if currentItem.modificationDate|date("d.m.Y") == "now"|date("d.m.Y") %}
                                                                    {{ 'today'|trans({})|capitalize }}, {{ currentItem.modificationDate|date("H:i") }}
                                                                {% else %}
                                                                    {{ currentItem.modificationDate|craue_date }}
                                                                {% endif %}
                                                            </span>
                                                                </div>
                                                            </div>
                                                            <div class="uk-width-8-10">
                                                                <h4 class="uk-comment-title">
                                                                    <a href="">{{ currentItem.title|decodeHtmlEntity }}</a>
                                                                </h4>
                                                                <div class="uk-comment-meta">
                                                                    {% if currentItem.author is defined and currentItem.author != '' %}
                                                                        {{ 'by'|trans({})|capitalize }}: {{currentItem.author}} ({{currentItem.publishingdate}})
                                                                    {% else %}
                                                                        {{ 'by'|trans({})|capitalize }}: {{ macros.userFullname(currentItem.modificatorItem) }} ({{ currentItem.creationDate|craue_date }})
                                                                    {% endif %}
                                                                </div>
                                                                <div class="uk-comment-meta">
                                                                    {{ macros.fileListShort(currentItem) }}
                                                                </div>
                                                            </div>
                                                            <div class="uk-width-2-10 uk-text-right">
                                                                <i class="{{ macros.iconClassForItemType(currentItem.itemType) }} uk-icon-small"></i>
                                                            </div>
                                                        </header>
                                                    </article>
                                                {% endif %}
                                            {% endfor %}

                                        </ul>
                                    </div>

                                </div>
                            </div>
                        </li>
                        {% if showCategories %}
                            <li>
                                {{ form_widget(form.categories) }}
                            </li>
                        {% else %}
                            {% do form.categories.setRendered %}
                        {% endif %}

                        {% if showHashtags %}
                            {% do form.hashtags.setRendered %}
                            <li>
                                <div class="uk-grid-width-small-1-4 hashtag-form" data-uk-grid data-uk-check-display>
                                    {% for hashtag in form.hashtags %}
                                        <div>
                                            {{ form_widget(hashtag) }}
                                            {{ form_label(hashtag) }}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="uk-margin-top uk-flex">
                                    <div class="uk-margin-small-left">
                                        {{ form_widget(form.newHashtag) }}
                                    </div>
                                    <div class="uk-margin-small-left">
                                        {{ form_widget(form.newHashtagAdd) }}
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            {% for hashtag in form.hashtags %}
                                {% do hashtag.setRendered %}
                            {% endfor %}
                            {% do form.newHashtag.setRendered %}
                            {% do form.newHashtagAdd.setRendered %}
                        {% endif %}
                    </ul>
                {% endif %}

                <div class="uk-form-row">
                    {{ form_label(form.biblio_select) }}
                    {{ form_widget(form.biblio_select) }}
                </div>
                {% if form.biblio_sub is defined %}
                    <div class="uk-margin-small-top">
                        <div id="material_biblio_sub">
                            {% for subField in form.biblio_sub %}
                                <div class="uk-flex uk-margin-small-top">
                                    <div>
                                        {{ form_row(subField) }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <div class="uk-form-row">
                    {{ form_label(form.license_id) }}
                    {{ form_widget(form.license_id) }}
                    <div id="licensesContents" class="uk-hidden">
                        {% for id, content in licensesContent %}
                            <span id="licensesContents_{{ id }}" class="uk-hidden">{{ content|raw }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="uk-flex uk-margin-small-top">
            <div class="uk-margin-small-left">
                {{ form_row(form.save) }}
            </div>
            <div class="uk-margin-small-left">
                {{ form_row(form.cancel) }}
            </div>
        </div>
        {{ form_row(form._token) }}
        {{ form_end(form, {'render_rest': false}) }}
    </div>
</div>

<script>
window.onload = function(){
    var linkLabels = document.querySelectorAll('#mandatoryLinksForm .uk-form-label');
    for (i = 0; i < linkLabels.length; i++) {
        linkLabels[i].classList.add('uk-text-truncate');
    }
}
var $biblio = $('#material_biblio_select');
// When sport gets selected ...
$biblio.change(function() {
    // ... retrieve the corresponding form.
    var $form = $(this).closest('form');
    // Simulate form data, but only include the selected sport value.
    var data = {};

    data[$(this).attr('name')] = $(this).val();
    // Submit data via AJAX to the form's action path.
    $.ajax({
        url : $form.attr('action'),
        type: $form.attr('method'),
        data : data,
        success: function(html) {
            // Replace current position field ...
            // add field
            if (!$('#material_biblio_sub').length) {
                $('#material_biblio_select').after(
                // ... with the returned one from the AJAX response.
                $(html).find('#material_biblio_sub')
                // html
                );
            } else {
                $('#material_biblio_sub').replaceWith(
                // ... with the returned one from the AJAX response.
                $(html).find('#material_biblio_sub')
                // html
                );
            }
            // console.log(html);
            // Position field now displays the appropriate positions.
        }
    });
});

if ($('#material_license_id').val() !== '') {
    $('#licensesContents').removeClass('uk-hidden');
    $('#licensesContents_'+$('#material_license_id').val()).removeClass('uk-hidden');
}

$('#material_license_id').on('change', function(){
    var $this = $(this);

    if ($this.val() === '') {
        $('#licensesContents').addClass('uk-hidden');
    } else {
        $('#licensesContents').removeClass('uk-hidden');
    }

    $('#licensesContents').find('span').each(function() {
        $(this).addClass('uk-hidden');
    });
    $('#licensesContents_'+$this.val()).removeClass('uk-hidden');
});

var feedAmount = 40;
var scrolledToEnd = false;

//$("input[id^='itemLinks_rubricFilter_']").each(function() {
$('#itemLinks_filterRubric').change(function(){
    filterItems($(this));
});

$('#itemLinks_filterPublic').change(function(){
    filterItems($(this));
});

$('#itemLinks_filterSearch').change(function(){
    filterItems($(this));
});

function filterItems(element) {
    var article = element.parents('.cs-edit-section');
    $(article).find('.cs-save-spinner').toggleClass('uk-hidden', false);
    $data = $("select[id^='itemLinks_filter']").add($("input[id^='itemLinks']:checked"));
    $data = $data.add($('<input type="hidden" id="itemLinks_feedAmount" name="itemLinks[feedAmount]" value="20" />'));
    $data = $data.add($('input[id^=itemLinks_filterSearch]'));

    var $form = element.closest('form');
    $.ajax({
        url : '/commsy.php/room/{{ roomId }}/item/{{ itemId }}/editlinks',
        type: $form.attr('method'),
        data : $data,
        success: function(html) {
            $(article).find('.cs-save-spinner').toggleClass('uk-hidden', true);

            $('#itemsList').replaceWith(
                $(html).find('#itemsList')
            );
        }
    });
}

$('.form-load-more').bind('scroll', function() {
    if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
        if (!scrolledToEnd) {
            scrolledToEnd = true;

            var article = $(this).parents('.cs-edit-section');
            $(article).find('.cs-save-spinner').toggleClass('uk-hidden', false);

            var $form = $(this).closest('form');
            $.ajax({
                url : '/commsy.php/room/{{ roomId }}/item/{{ itemId }}/editlinks/'+feedAmount,
                type: $form.attr('method'),
                success: function(html) {
                    $(article).find('.cs-save-spinner').toggleClass('uk-hidden', true);

                    /* $('#itemsLinkedList').replaceWith(
                        $(html).find('#itemsLinkedList')
                    ); */

                    $('#itemsList').replaceWith(
                        $(html).find('#itemsList')
                    );

                    scrolledToEnd = false;
                    feedAmount += 20;
                }
            });
        }
    }
});
//});
</script>